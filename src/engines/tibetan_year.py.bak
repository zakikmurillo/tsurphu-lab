from __future__ import annotations

from dataclasses import dataclass
from pathlib import Path
import csv
from typing import Optional, Tuple


# Base estándar sexagenaria (muy estable): 1984 = Wood Rat
# Elementos por tallo (10): Wood, Wood, Fire, Fire, Earth, Earth, Metal, Metal, Water, Water
_STEMS = ["Wood","Wood","Fire","Fire","Earth","Earth","Metal","Metal","Water","Water"]

# Animales por rama (12) — en tibetano suele usarse "Bird" para Rooster
_ANIMALS = ["Rat","Ox","Tiger","Rabbit","Dragon","Snake","Horse","Sheep","Monkey","Bird","Dog","Pig"]


@dataclass(frozen=True)
class TibetanYear:
    gregorian_year: int
    element: str
    animal: str
    stem_index: int
    branch_index: int
    mewa: Optional[str] = None
    parkha: Optional[str] = None


def sexagenary_from_gregorian(year: int) -> Tuple[str, str, int, int]:
    """
    Retorna (element, animal, stem_index, branch_index) para el año gregoriano.
    Nota: esto NO ajusta por Losar (inicio de año tibetano). Es la base del ciclo.
    """
    delta = year - 1984
    stem_i = delta % 10
    branch_i = delta % 12
    return _STEMS[stem_i], _ANIMALS[branch_i], stem_i, branch_i


def lookup_mewa_parkha(year: int, *, lookup_csv: Path) -> Tuple[Optional[str], Optional[str]]:
    """
    Hook seguro: si existe un CSV validado por nosotros, lo usamos.
    CSV: year,mewa,parkha,notes
    """
    if not lookup_csv.exists():
        return None, None

    with lookup_csv.open("r", encoding="utf-8-sig", newline="") as f:
        r = csv.DictReader(f)
        for row in r:
            try:
                y = int((row.get("year") or "").strip())
            except Exception:
                continue
            if y == year:
                mewa = (row.get("mewa") or "").strip() or None
                parkha = (row.get("parkha") or "").strip() or None
                return mewa, parkha
    return None, None


def tibetan_year(year: int, *, lookups_dir: Path | None = None) -> TibetanYear:
    element, animal, stem_i, branch_i = sexagenary_from_gregorian(year)

    mewa = parkha = None
    if lookups_dir is not None:
        csv_path = lookups_dir / "year_mewa_parkha.csv"
        mewa, parkha = lookup_mewa_parkha(year, lookup_csv=csv_path)

    return TibetanYear(
        gregorian_year=year,
        element=element,
        animal=animal,
        stem_index=stem_i,
        branch_index=branch_i,
        mewa=mewa,
        parkha=parkha,
    )
